<!-- src/main/resources/templates/common/navigation.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
<nav th:fragment="navigation" class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container">
    <a class="navbar-brand" href="/">ğŸ“š ì˜¨ë¼ì¸ ì„œì </a>
    <div class="navbar-nav ms-auto">
      <!-- ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œ í‘œì‹œ -->
      <span id="user-greeting" class="navbar-text me-3" style="display: none;">
        ì•ˆë…•í•˜ì„¸ìš”, <span id="user-name">ì‚¬ìš©ìë‹˜</span>!
      </span>

      <!-- ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ë©”ë‰´ -->
      <div id="logged-in-menu" class="navbar-nav" style="display: none;">
        <a class="nav-link" href="/mypage">ë§ˆì´í˜ì´ì§€</a>
        <a class="nav-link" href="/cart">ì¥ë°”êµ¬ë‹ˆ</a>
        <a class="nav-link" href="#" id="logout-btn">ë¡œê·¸ì•„ì›ƒ</a>
      </div>

      <!-- ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ì‚¬ìš©ì ë©”ë‰´ -->
      <div id="logged-out-menu" class="navbar-nav">
        <a class="nav-link" href="/login">ë¡œê·¸ì¸</a>
        <a class="nav-link" href="/signup">íšŒì›ê°€ì…</a>
      </div>
    </div>
  </div>
</nav>

<script th:fragment="navigation-script">
  // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
  document.addEventListener('DOMContentLoaded', function() {
    checkAuthStatus();
  });

  // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ í•¨ìˆ˜ (sessionStorage ì‚¬ìš©)
  async function checkAuthStatus() {
    console.log('ì¸ì¦ ìƒíƒœ í™•ì¸ ì¤‘...');

    // 1. sessionStorageì—ì„œ í† í° ë³µêµ¬ ì‹œë„
    const storedToken = sessionStorage.getItem('accessToken');
    if (storedToken) {
      window.accessToken = storedToken;
      const userData = JSON.parse(sessionStorage.getItem('userData') || '{}');
      console.log('sessionStorageì—ì„œ í† í° ë³µêµ¬ë¨:', userData);
      showLoggedInState({ data: userData });
      return;
    }

    // 2. sessionStorageì— í† í°ì´ ì—†ìœ¼ë©´ Refresh Tokenìœ¼ë¡œ ì¬ë°œê¸‰ ì‹œë„
    console.log('sessionStorageì— í† í°ì´ ì—†ì–´ì„œ refresh ì‹œë„');
    await refreshAccessToken();
  }

  // Refresh Tokenìœ¼ë¡œ Access Token ì¬ë°œê¸‰
  async function refreshAccessToken() {
    try {
      console.log('Refresh Tokenìœ¼ë¡œ í† í° ê°±ì‹  ì‹œë„...');
      const response = await fetch('/api/member/refresh', {
        method: 'POST',
        credentials: 'include' // ì¿ í‚¤ì˜ refreshToken í¬í•¨
      });

      if (response.ok) {
        const result = await response.json();
        console.log('í† í° ê°±ì‹  ì‘ë‹µ:', result);

        if (result.success && result.data && result.data.accessToken) {
          // ìƒˆë¡œìš´ Access Tokenì„ sessionStorageì™€ ë©”ëª¨ë¦¬ì— ì €ì¥
          sessionStorage.setItem('accessToken', result.data.accessToken);
          window.accessToken = result.data.accessToken;
          console.log('í† í° ê°±ì‹  ì„±ê³µ, sessionStorageì— ì €ì¥ë¨');

          // ë¡œê·¸ì¸ ìƒíƒœ UI í‘œì‹œ (ê¸°ë³¸ ì‚¬ìš©ì ì •ë³´)
          const defaultUser = { nickname: 'ì‚¬ìš©ì' };
          sessionStorage.setItem('userData', JSON.stringify(defaultUser));
          showLoggedInState({ data: defaultUser });
        } else {
          console.log('í† í° ê°±ì‹  ì‹¤íŒ¨ - ì‘ë‹µ ë°ì´í„° ë¬¸ì œ');
          showLoggedOutState();
        }
      } else {
        console.log('í† í° ê°±ì‹  ì‹¤íŒ¨ - HTTP ì‘ë‹µ ì‹¤íŒ¨:', response.status);
        showLoggedOutState();
      }
    } catch (error) {
      console.error('í† í° ê°±ì‹  ì¤‘ ì˜¤ë¥˜:', error);
      showLoggedOutState();
    }
  }

  // ë¡œê·¸ì¸ ìƒíƒœ UI í‘œì‹œ
  function showLoggedInState(userData) {
    console.log('ë¡œê·¸ì¸ UI í‘œì‹œ:', userData);

    if (userData && userData.data) {
      const nickname = userData.data.nickname || userData.data.name || 'ì‚¬ìš©ìë‹˜';
      const userNameElement = document.getElementById('user-name');
      if (userNameElement) {
        userNameElement.textContent = nickname;
      }
    }

    const userGreeting = document.getElementById('user-greeting');
    const loggedInMenu = document.getElementById('logged-in-menu');
    const loggedOutMenu = document.getElementById('logged-out-menu');

    if (userGreeting) userGreeting.style.display = 'block';
    if (loggedInMenu) loggedInMenu.style.display = 'flex';
    if (loggedOutMenu) loggedOutMenu.style.display = 'none';
  }

  // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ UI í‘œì‹œ
  function showLoggedOutState() {
    console.log('ë¡œê·¸ì•„ì›ƒ UI í‘œì‹œ');

    // ë©”ëª¨ë¦¬ì™€ sessionStorageì—ì„œ í† í° ì œê±°
    window.accessToken = null;
    window.userData = null;
    sessionStorage.removeItem('accessToken');
    sessionStorage.removeItem('userData');

    const userGreeting = document.getElementById('user-greeting');
    const loggedInMenu = document.getElementById('logged-in-menu');
    const loggedOutMenu = document.getElementById('logged-out-menu');

    if (userGreeting) userGreeting.style.display = 'none';
    if (loggedInMenu) loggedInMenu.style.display = 'none';
    if (loggedOutMenu) loggedOutMenu.style.display = 'flex';
  }

  // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
  document.addEventListener('DOMContentLoaded', function() {
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', async function(e) {
        e.preventDefault();

        try {
          await fetch('/api/member/logout', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${window.accessToken}`
            },
            credentials: 'include'
          });
        } catch (error) {
          console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
        }

        showLoggedOutState();
        window.location.href = '/';
      });
    }
  });

  // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ
  window.updateAuthStatus = checkAuthStatus;
</script>
</body>
</html>