<!-- src/main/resources/templates/common/navigation.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<!-- 네비게이션 바 -->
<nav th:fragment="navigation" class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container">
    <a class="navbar-brand" href="/">📚 온라인 서점</a>
    <div class="navbar-nav ms-auto">
      <!-- 로그인 상태일 때 표시 -->
      <span id="user-greeting" class="navbar-text me-3" style="display: none;">
        안녕하세요, <span id="user-name">사용자님</span>!
      </span>

      <!-- 로그인된 사용자 메뉴 -->
      <div id="logged-in-menu" class="navbar-nav" style="display: none;">
        <a class="nav-link" href="/mypage">마이페이지</a>
        <a class="nav-link" href="/cart">장바구니</a>
        <a class="nav-link" href="#" id="logout-btn">로그아웃</a>
      </div>

      <!-- 로그인하지 않은 사용자 메뉴 -->
      <div id="logged-out-menu" class="navbar-nav">
        <a class="nav-link" href="/login">로그인</a>
        <a class="nav-link" href="/signup">회원가입</a>
      </div>
    </div>
  </div>
</nav>

<script th:fragment="navigation-script">
  // 페이지 로드 시 로그인 상태 확인
  document.addEventListener('DOMContentLoaded', function() {
    checkAuthStatus();
  });

  // 로그인 상태 확인 함수 (sessionStorage 사용)
  async function checkAuthStatus() {
    console.log('인증 상태 확인 중...');

    // 1. sessionStorage에서 토큰 복구 시도
    const storedToken = sessionStorage.getItem('accessToken');
    if (storedToken) {
      window.accessToken = storedToken;
      const userData = JSON.parse(sessionStorage.getItem('userData') || '{}');
      console.log('sessionStorage에서 토큰 복구됨:', userData);
      showLoggedInState({ data: userData });
      return;
    }

    // 2. sessionStorage에 토큰이 없으면 Refresh Token으로 재발급 시도
    console.log('sessionStorage에 토큰이 없어서 refresh 시도');
    await refreshAccessToken();
  }

  // Refresh Token으로 Access Token 재발급
  async function refreshAccessToken() {
    try {
      console.log('Refresh Token으로 토큰 갱신 시도...');
      const response = await fetch('/api/member/refresh', {
        method: 'POST',
        credentials: 'include' // 쿠키의 refreshToken 포함
      });

      if (response.ok) {
        const result = await response.json();
        console.log('토큰 갱신 응답:', result);

        if (result.success && result.data && result.data.accessToken) {
          // 새로운 Access Token을 sessionStorage와 메모리에 저장
          sessionStorage.setItem('accessToken', result.data.accessToken);
          window.accessToken = result.data.accessToken;
          console.log('토큰 갱신 성공, sessionStorage에 저장됨');

          // 로그인 상태 UI 표시 (기본 사용자 정보)
          const defaultUser = { nickname: '사용자' };
          sessionStorage.setItem('userData', JSON.stringify(defaultUser));
          showLoggedInState({ data: defaultUser });
        } else {
          console.log('토큰 갱신 실패 - 응답 데이터 문제');
          showLoggedOutState();
        }
      } else {
        console.log('토큰 갱신 실패 - HTTP 응답 실패:', response.status);
        showLoggedOutState();
      }
    } catch (error) {
      console.error('토큰 갱신 중 오류:', error);
      showLoggedOutState();
    }
  }

  // 로그인 상태 UI 표시
  function showLoggedInState(userData) {
    console.log('로그인 UI 표시:', userData);

    if (userData && userData.data) {
      const nickname = userData.data.nickname || userData.data.name || '사용자님';
      const userNameElement = document.getElementById('user-name');
      if (userNameElement) {
        userNameElement.textContent = nickname;
      }
    }

    const userGreeting = document.getElementById('user-greeting');
    const loggedInMenu = document.getElementById('logged-in-menu');
    const loggedOutMenu = document.getElementById('logged-out-menu');

    if (userGreeting) userGreeting.style.display = 'block';
    if (loggedInMenu) loggedInMenu.style.display = 'flex';
    if (loggedOutMenu) loggedOutMenu.style.display = 'none';
  }

  // 로그아웃 상태 UI 표시
  function showLoggedOutState() {
    console.log('로그아웃 UI 표시');

    // 메모리와 sessionStorage에서 토큰 제거
    window.accessToken = null;
    window.userData = null;
    sessionStorage.removeItem('accessToken');
    sessionStorage.removeItem('userData');

    const userGreeting = document.getElementById('user-greeting');
    const loggedInMenu = document.getElementById('logged-in-menu');
    const loggedOutMenu = document.getElementById('logged-out-menu');

    if (userGreeting) userGreeting.style.display = 'none';
    if (loggedInMenu) loggedInMenu.style.display = 'none';
    if (loggedOutMenu) loggedOutMenu.style.display = 'flex';
  }

  // 로그아웃 처리
  document.addEventListener('DOMContentLoaded', function() {
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', async function(e) {
        e.preventDefault();

        try {
          await fetch('/api/member/logout', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${window.accessToken}`
            },
            credentials: 'include'
          });
        } catch (error) {
          console.error('로그아웃 실패:', error);
        }

        showLoggedOutState();
        window.location.href = '/';
      });
    }
  });

  // 전역 함수로 노출
  window.updateAuthStatus = checkAuthStatus;
</script>
</body>
</html>