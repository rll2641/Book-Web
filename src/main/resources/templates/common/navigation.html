<!-- src/main/resources/templates/common/navigation.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>
<!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
<nav th:fragment="navigation" class="navbar navbar-expand-lg navbar-light bg-light">
  <div class="container">
    <a class="navbar-brand" href="/">ğŸ“š ì˜¨ë¼ì¸ ì„œì </a>
    <div class="navbar-nav ms-auto">

      <!-- ë¡œê·¸ì¸ëœ ì‚¬ìš©ì ë©”ë‰´ -->
      <div id="logged-in-menu" class="navbar-nav" style="display: none;">
        <a class="nav-link" href="/mypage">ë§ˆì´í˜ì´ì§€</a>
        <a class="nav-link" href="/cart">ì¥ë°”êµ¬ë‹ˆ</a>
        <a class="nav-link" href="#" id="logout-btn">ë¡œê·¸ì•„ì›ƒ</a>
      </div>

      <!-- ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ì‚¬ìš©ì ë©”ë‰´ -->
      <div id="logged-out-menu" class="navbar-nav">
        <a class="nav-link" href="/login">ë¡œê·¸ì¸</a>
        <a class="nav-link" href="/signup">íšŒì›ê°€ì…</a>
      </div>
    </div>
  </div>
</nav>

<script th:fragment="navigation-script">
  // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
  document.addEventListener('DOMContentLoaded', function() {
    // DOMì´ ì™„ì „íˆ ë¡œë“œëœ í›„ ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ê³  ì‹¤í–‰
    setTimeout(() => {
      checkAuthStatus();
    }, 100);
  });

  // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ í•¨ìˆ˜ (ê°œì„ ëœ ë²„ì „)
  async function checkAuthStatus() {
    console.log('ì¸ì¦ ìƒíƒœ í™•ì¸ ì¤‘...');
    console.log('í˜„ì¬ í˜ì´ì§€:', window.location.pathname);
    console.log('sessionStorage í† í°:', sessionStorage.getItem('accessToken') ? 'ì¡´ì¬' : 'ì—†ìŒ');
    console.log('ì¿ í‚¤ í™•ì¸:', document.cookie.includes('refreshToken') ? 'ì¡´ì¬' : 'ì—†ìŒ');

    // 1. ë°©ê¸ˆ ë¡œê·¸ì¸í–ˆëŠ”ì§€ í™•ì¸
    const justLoggedIn = sessionStorage.getItem('justLoggedIn');
    if (justLoggedIn) {
      console.log('ë°©ê¸ˆ ë¡œê·¸ì¸í•œ ìƒíƒœ ê°ì§€');
      sessionStorage.removeItem('justLoggedIn');
      // ì§§ì€ ì§€ì—° í›„ ë‹¤ì‹œ í™•ì¸ (DOM ì™„ì „ ë¡œë”© ëŒ€ê¸°)
      setTimeout(() => checkAuthStatus(), 200);
      return;
    }

    // 2. sessionStorageì—ì„œ í† í° ë³µêµ¬ ì‹œë„
    const storedToken = sessionStorage.getItem('accessToken');
    if (storedToken) {
      window.accessToken = storedToken;
      const userData = JSON.parse(sessionStorage.getItem('userData') || '{}');
      console.log('sessionStorageì—ì„œ í† í° ë³µêµ¬ë¨:', userData);
      showLoggedInState({ data: userData });
      return;
    }

    // 3. sessionStorageì— í† í°ì´ ì—†ìœ¼ë©´ Refresh Tokenìœ¼ë¡œ ì¬ë°œê¸‰ ì‹œë„
    console.log('sessionStorageì— í† í°ì´ ì—†ì–´ì„œ refresh ì‹œë„');
    await refreshAccessToken();
  }

  // Refresh Tokenìœ¼ë¡œ Access Token ì¬ë°œê¸‰ (ê°œì„ ëœ ë²„ì „)
  async function refreshAccessToken() {
    try {
      console.log('Refresh Tokenìœ¼ë¡œ í† í° ê°±ì‹  ì‹œë„...');
      const response = await fetch('/api/member/refresh', {
        method: 'POST',
        credentials: 'include' // ì¿ í‚¤ì˜ refreshToken í¬í•¨
      });

      console.log('í† í° ê°±ì‹  ì‘ë‹µ ìƒíƒœ:', response.status);

      if (response.ok) {
        const result = await response.json();
        console.log('í† í° ê°±ì‹  ì‘ë‹µ:', result);

        if (result.success && result.data && result.data.accessToken) {
          // ìƒˆë¡œìš´ Access Tokenì„ sessionStorageì™€ ë©”ëª¨ë¦¬ì— ì €ì¥
          sessionStorage.setItem('accessToken', result.data.accessToken);
          window.accessToken = result.data.accessToken;
          console.log('í† í° ê°±ì‹  ì„±ê³µ, sessionStorageì— ì €ì¥ë¨');

          // ì‚¬ìš©ì ì •ë³´ê°€ ìˆìœ¼ë©´ ì €ì¥, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
          let userData;
          if (result.data.user) {
            userData = result.data.user;
            sessionStorage.setItem('userData', JSON.stringify(userData));
          } else {
            // ê¸°ë³¸ ì‚¬ìš©ì ì •ë³´ (APIì—ì„œ ì‚¬ìš©ì ì •ë³´ë¥¼ ë°˜í™˜í•˜ì§€ ì•ŠëŠ” ê²½ìš°)
            userData = { nickname: 'ì‚¬ìš©ì' };
            sessionStorage.setItem('userData', JSON.stringify(userData));
          }

          // ë¡œê·¸ì¸ ìƒíƒœ UI í‘œì‹œ
          showLoggedInState({ data: userData });
        } else {
          console.log('í† í° ê°±ì‹  ì‹¤íŒ¨ - ì‘ë‹µ ë°ì´í„° ë¬¸ì œ:', result);
          showLoggedOutState();
        }
      } else {
        console.log('í† í° ê°±ì‹  ì‹¤íŒ¨ - HTTP ì‘ë‹µ ì‹¤íŒ¨:', response.status);
        showLoggedOutState();
      }
    } catch (error) {
      console.error('í† í° ê°±ì‹  ì¤‘ ì˜¤ë¥˜:', error);
      showLoggedOutState();
    }
  }

  // ë¡œê·¸ì¸ ìƒíƒœ UI í‘œì‹œ (ê°œì„ ëœ ë²„ì „)
  function showLoggedInState(userData) {
    console.log('ë¡œê·¸ì¸ UI í‘œì‹œ:', userData);

    // ì‚¬ìš©ì ì´ë¦„ ì„¤ì •
    if (userData && userData.data) {
      const nickname = userData.data.nickname || userData.data.name || 'ì‚¬ìš©ìë‹˜';
      const userNameElement = document.getElementById('user-name');
      if (userNameElement) {
        userNameElement.textContent = nickname;
      }
    }

    // UI ìš”ì†Œë“¤ ê°€ì ¸ì˜¤ê¸°
    const userGreeting = document.getElementById('user-greeting');
    const loggedInMenu = document.getElementById('logged-in-menu');
    const loggedOutMenu = document.getElementById('logged-out-menu');

    // ë¶€ë“œëŸ¬ìš´ ì „í™˜ íš¨ê³¼ì™€ í•¨ê»˜ UI ì—…ë°ì´íŠ¸
    if (loggedOutMenu) {
      loggedOutMenu.style.transition = 'opacity 0.3s ease';
      loggedOutMenu.style.opacity = '0';

      setTimeout(() => {
        loggedOutMenu.style.display = 'none';

        if (userGreeting) {
          userGreeting.style.display = 'block';
          userGreeting.style.opacity = '0';
          userGreeting.style.transition = 'opacity 0.3s ease';
          setTimeout(() => userGreeting.style.opacity = '1', 50);
        }

        if (loggedInMenu) {
          loggedInMenu.style.display = 'flex';
          loggedInMenu.style.opacity = '0';
          loggedInMenu.style.transition = 'opacity 0.3s ease';
          setTimeout(() => loggedInMenu.style.opacity = '1', 50);
        }
      }, 300);
    } else {
      // ì „í™˜ íš¨ê³¼ ì—†ì´ ë°”ë¡œ í‘œì‹œ
      if (userGreeting) userGreeting.style.display = 'block';
      if (loggedInMenu) loggedInMenu.style.display = 'flex';
    }
  }

  // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ UI í‘œì‹œ (ê°œì„ ëœ ë²„ì „)
  function showLoggedOutState() {
    console.log('ë¡œê·¸ì•„ì›ƒ UI í‘œì‹œ');

    // ë©”ëª¨ë¦¬ì™€ sessionStorageì—ì„œ í† í° ì œê±°
    window.accessToken = null;
    window.userData = null;
    sessionStorage.removeItem('accessToken');
    sessionStorage.removeItem('userData');
    sessionStorage.removeItem('justLoggedIn'); // ì¶”ê°€

    // UI ìš”ì†Œë“¤ ê°€ì ¸ì˜¤ê¸°
    const userGreeting = document.getElementById('user-greeting');
    const loggedInMenu = document.getElementById('logged-in-menu');
    const loggedOutMenu = document.getElementById('logged-out-menu');

    // ë¶€ë“œëŸ¬ìš´ ì „í™˜ íš¨ê³¼ì™€ í•¨ê»˜ UI ì—…ë°ì´íŠ¸
    if (loggedInMenu) {
      loggedInMenu.style.transition = 'opacity 0.3s ease';
      loggedInMenu.style.opacity = '0';

      setTimeout(() => {
        if (userGreeting) userGreeting.style.display = 'none';
        if (loggedInMenu) loggedInMenu.style.display = 'none';

        if (loggedOutMenu) {
          loggedOutMenu.style.display = 'flex';
          loggedOutMenu.style.opacity = '0';
          loggedOutMenu.style.transition = 'opacity 0.3s ease';
          setTimeout(() => loggedOutMenu.style.opacity = '1', 50);
        }
      }, 300);
    } else {
      // ì „í™˜ íš¨ê³¼ ì—†ì´ ë°”ë¡œ í‘œì‹œ
      if (userGreeting) userGreeting.style.display = 'none';
      if (loggedInMenu) loggedInMenu.style.display = 'none';
      if (loggedOutMenu) loggedOutMenu.style.display = 'flex';
    }
  }

  // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ (ê°œì„ ëœ ë²„ì „)
  document.addEventListener('DOMContentLoaded', function() {
    const logoutBtn = document.getElementById('logout-btn');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', async function(e) {
        e.preventDefault();

        console.log('ë¡œê·¸ì•„ì›ƒ ì‹œë„...');

        try {
          const response = await fetch('/api/member/logout', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${window.accessToken || sessionStorage.getItem('accessToken')}`
            },
            credentials: 'include'
          });

          if (response.ok) {
            console.log('ì„œë²„ ë¡œê·¸ì•„ì›ƒ ì„±ê³µ');
          } else {
            console.log('ì„œë²„ ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨, í´ë¼ì´ì–¸íŠ¸ì—ì„œë§Œ ì •ë¦¬');
          }
        } catch (error) {
          console.error('ë¡œê·¸ì•„ì›ƒ ìš”ì²­ ì‹¤íŒ¨:', error);
        }

        // í´ë¼ì´ì–¸íŠ¸ ìƒíƒœ ì •ë¦¬ ë° UI ì—…ë°ì´íŠ¸
        showLoggedOutState();

        // ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
        setTimeout(() => {
          window.location.href = '/';
        }, 500);
      });
    }
  });

  // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ (ë‹¤ë¥¸ í˜ì´ì§€ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥)
  window.updateAuthStatus = checkAuthStatus;
  window.showLoggedInState = showLoggedInState;
  window.showLoggedOutState = showLoggedOutState;

  // API í˜¸ì¶œ ì‹œ í† í° ë§Œë£Œ ìë™ ì²˜ë¦¬ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
  window.apiCall = async function(url, options = {}) {
    let token = window.accessToken || sessionStorage.getItem('accessToken');

    const response = await fetch(url, {
      ...options,
      headers: {
        ...options.headers,
        'Authorization': token ? `Bearer ${token}` : undefined
      }
    });

    if (response.status === 401) {
      console.log('í† í° ë§Œë£Œ ê°ì§€, ìë™ ê°±ì‹  ì‹œë„...');
      // í† í° ë§Œë£Œ ì‹œ ìë™ ê°±ì‹  ì‹œë„
      await refreshAccessToken();
      token = window.accessToken || sessionStorage.getItem('accessToken');

      if (token) {
        // ê°±ì‹ ëœ í† í°ìœ¼ë¡œ ì¬ì‹œë„
        return fetch(url, {
          ...options,
          headers: {
            ...options.headers,
            'Authorization': `Bearer ${token}`
          }
        });
      }
    }

    return response;
  };
</script>
</body>
</html>
