<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>로그인 - 온라인 서점</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    .navbar-brand {
      font-weight: bold;
      color: #2c3e50 !important;
    }

    .login-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      padding: 20px 0;
    }

    .login-container {
      background-color: white;
      border-radius: 15px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      max-width: 900px;
      width: 100%;
    }

    .login-left {
      background: linear-gradient(45deg, #2c3e50, #3498db);
      color: white;
      padding: 60px 40px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }

    .login-left h2 {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 20px;
    }

    .login-left p {
      font-size: 1.1rem;
      opacity: 0.9;
      line-height: 1.6;
    }

    .login-left .book-icon {
      font-size: 4rem;
      margin-bottom: 30px;
      opacity: 0.8;
    }

    .login-right {
      padding: 60px 40px;
    }

    .login-form-title {
      font-size: 2rem;
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 10px;
      text-align: center;
    }

    .login-form-subtitle {
      color: #6c757d;
      text-align: center;
      margin-bottom: 40px;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-label {
      font-weight: 600;
      color: #495057;
      margin-bottom: 8px;
    }

    .form-control {
      border: 2px solid #e9ecef;
      border-radius: 10px;
      padding: 15px;
      font-size: 1rem;
      transition: all 0.3s;
    }

    .form-control:focus {
      border-color: #007bff;
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .input-icon {
      position: relative;
    }

    .input-icon i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #6c757d;
      z-index: 10;
    }

    .input-icon .form-control {
      padding-left: 45px;
    }

    .btn-login {
      background: linear-gradient(45deg, #007bff, #0056b3);
      border: none;
      border-radius: 10px;
      padding: 15px;
      font-size: 1.1rem;
      font-weight: 600;
      color: white;
      width: 100%;
      transition: all 0.3s;
      margin-bottom: 20px;
    }

    .btn-login:hover {
      background: linear-gradient(45deg, #0056b3, #004085);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
    }

    .btn-google {
      background-color: #ffffff;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      padding: 15px;
      font-size: 1rem;
      font-weight: 600;
      color: #495057;
      width: 100%;
      transition: all 0.3s;
      margin-bottom: 20px;
    }

    .btn-google:hover {
      background-color: #f8f9fa;
      border-color: #dee2e6;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .google-icon {
      width: 20px;
      height: 20px;
      margin-right: 10px;
    }

    .divider {
      text-align: center;
      margin: 30px 0;
      position: relative;
    }

    .divider::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 1px;
      background-color: #dee2e6;
    }

    .divider span {
      background-color: white;
      color: #6c757d;
      padding: 0 20px;
      font-size: 0.9rem;
    }

    .form-check {
      margin-bottom: 25px;
    }

    .form-check-input:checked {
      background-color: #007bff;
      border-color: #007bff;
    }

    .forgot-password {
      color: #007bff;
      text-decoration: none;
      font-size: 0.9rem;
    }

    .forgot-password:hover {
      text-decoration: underline;
    }

    .signup-link {
      text-align: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #dee2e6;
    }

    .signup-link a {
      color: #007bff;
      text-decoration: none;
      font-weight: 600;
    }

    .signup-link a:hover {
      text-decoration: underline;
    }

    .alert {
      border-radius: 10px;
      margin-bottom: 25px;
    }

    @media (max-width: 768px) {
      .login-container {
        margin: 20px;
      }

      .login-left {
        padding: 40px 20px;
      }

      .login-left h2 {
        font-size: 2rem;
      }

      .login-left .book-icon {
        font-size: 3rem;
        margin-bottom: 20px;
      }

      .login-right {
        padding: 40px 20px;
      }

      .login-form-title {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
<!-- 네비게이션 바 -->
<div th:replace="~{common/navigation :: navigation}"></div>

<div class="login-section">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12">
        <div class="login-container mx-auto">
          <div class="row g-0">
            <!-- 왼쪽 브랜딩 영역 -->
            <div class="col-lg-6 d-none d-lg-block">
              <div class="login-left">
                <div class="book-icon">
                  <i class="fas fa-book-open"></i>
                </div>
                <h2>온라인 서점</h2>
                <p>수백만 권의 도서와 함께<br>
                  새로운 지식의 여행을 시작하세요</p>
                <div class="mt-4">
                  <i class="fas fa-star me-1"></i>
                  <i class="fas fa-star me-1"></i>
                  <i class="fas fa-star me-1"></i>
                  <i class="fas fa-star me-1"></i>
                  <i class="fas fa-star"></i>
                  <small class="ms-2">10만+ 사용자가 선택한 서점</small>
                </div>
              </div>
            </div>

            <!-- 오른쪽 로그인 폼 -->
            <div class="col-lg-6">
              <div class="login-right">
                <h1 class="login-form-title">로그인</h1>
                <p class="login-form-subtitle">계정에 로그인하여 더 많은 서비스를 이용하세요</p>

                <!-- 에러/성공 메시지 영역 -->
                <div id="messageArea">
                  <!-- 서버에서 전달되는 에러/성공 메시지 -->
                  <div th:if="${errorMessage}" class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span th:text="${errorMessage}">로그인에 실패했습니다.</span>
                  </div>

                  <div th:if="${successMessage}" class="alert alert-success" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    <span th:text="${successMessage}">성공적으로 처리되었습니다.</span>
                  </div>
                </div>

                <!-- 로그인 폼 -->
                <form id="loginForm" onsubmit="return handleLogin(event)">
                  <!-- 이메일 -->
                  <div class="form-group">
                    <label for="email" class="form-label">이메일</label>
                    <div class="input-icon">
                      <i class="fas fa-envelope"></i>
                      <input type="email"
                             class="form-control"
                             id="email"
                             name="email"
                             placeholder="이메일을 입력하세요"
                             required>
                    </div>
                  </div>

                  <!-- 비밀번호 -->
                  <div class="form-group">
                    <label for="password" class="form-label">비밀번호</label>
                    <div class="input-icon">
                      <i class="fas fa-lock"></i>
                      <input type="password"
                             class="form-control"
                             id="password"
                             name="password"
                             placeholder="비밀번호를 입력하세요"
                             required>
                    </div>
                  </div>

                  <!-- 로그인 유지 & 비밀번호 찾기 -->
                  <div class="d-flex justify-content-between align-items-center mb-4">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="rememberMe" id="rememberMe">
                      <label class="form-check-label" for="rememberMe">
                        로그인 유지
                      </label>
                    </div>
                    <a href="/forgot-password" class="forgot-password">비밀번호를 잊으셨나요?</a>
                  </div>

                  <!-- 로그인 버튼 -->
                  <button type="submit" class="btn btn-login">
                    <i class="fas fa-sign-in-alt me-2"></i>로그인
                  </button>
                </form>

                <!-- 구분선 -->
                <div class="divider">
                  <span>또는</span>
                </div>

                <!-- 구글 로그인 -->
                <a href="/oauth/google/login" class="btn btn-google">
                  <img src="https://developers.google.com/identity/images/g-logo.png" alt="Google" class="google-icon">
                  Google로 로그인
                </a>

                <!-- 회원가입 링크 -->
                <div class="signup-link">
                  <span class="text-muted">아직 계정이 없으신가요? </span>
                  <a href="/signup">회원가입</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // 성공 메시지 표시 함수
  function showSuccess(message) {
    const messageArea = document.getElementById('messageArea');
    messageArea.innerHTML = `
      <div class="alert alert-success" role="alert">
        <i class="fas fa-check-circle me-2"></i>
        ${message}
      </div>
    `;
  }

  // 에러 메시지 표시 함수
  function showError(message) {
    const messageArea = document.getElementById('messageArea');
    messageArea.innerHTML = `
      <div class="alert alert-danger" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        ${message}
      </div>
    `;
  }

  // 로그인 처리 함수
  async function handleLogin(event) {
    event.preventDefault();

    const form = document.getElementById('loginForm');
    const submitBtn = document.querySelector('.btn-login');
    const originalText = submitBtn.innerHTML;

    // 로딩 상태
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>로그인 중...';
    submitBtn.disabled = true;

    // 폼 데이터 수집
    const formData = new FormData(form);
    const loginData = {
      email: formData.get('email'),
      password: formData.get('password')
    };

    console.log('로그인 시도:', loginData.email); // 디버깅

    try {
      const response = await fetch('/api/member/login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(loginData),
        credentials: 'include'  // 쿠키 포함해서 요청
      });

      console.log('응답 상태:', response.status); // 디버깅
      console.log('응답 OK:', response.ok); // 디버깅

      const result = await response.json();
      console.log('서버 응답 전체:', result); // 디버깅
      console.log('result.success:', result.success); // 디버깅
      console.log('result.success 타입:', typeof result.success); // 디버깅

      // SuccessApiResponse 구조: { success: true, message: "...", data: {...} }
      if (response.ok && result.success === true) {
        console.log('로그인 성공 조건 만족!'); // 디버깅

        // Access Token을 메모리에 저장
        if (result.data && result.data.accessToken) {
          window.accessToken = result.data.accessToken;
          console.log('Access Token 저장:', result.data.accessToken.substring(0, 20) + '...'); // 디버깅
        }

        console.log('로그인 성공 사용자:', result.data.user); // 디버깅

        // 성공시 메시지 표시
        showSuccess(result.message || '로그인에 성공했습니다!');

        // 1초 후 메인 페이지로 이동
        setTimeout(() => {
          console.log('페이지 이동 시작...'); // 디버깅
          window.location.href = '/';
        }, 1000);

      } else {
        console.log('로그인 실패 - response.ok:', response.ok, 'result.success:', result.success); // 디버깅
        // 실패시 에러 메시지 표시
        showError(result.message || '로그인에 실패했습니다.');
      }

    } catch (error) {
      console.error('Login error:', error); // 디버깅
      showError('로그인 중 오류가 발생했습니다.');
    } finally {
      // 로딩 상태 해제
      submitBtn.innerHTML = originalText;
      submitBtn.disabled = false;
    }

    return false;
  }

  // 로그아웃 함수
  async function logout() {
    try {
      // 메모리에서 Access Token 가져오기
      const accessToken = window.accessToken;

      const response = await fetch('/api/member/logout', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': accessToken ? `Bearer ${accessToken}` : ''
        },
        credentials: 'include'  // 쿠키 포함해서 요청
      });

      const result = await response.json();

      // SuccessApiResponse 구조
      if (result.success) {
        // 메모리에서 Access Token 삭제
        delete window.accessToken;

        console.log('로그아웃 성공');
        alert('로그아웃되었습니다.');

        // 로그인 페이지로 이동
        window.location.href = '/login';
      } else {
        console.error('로그아웃 실패:', result.message);
      }

    } catch (error) {
      console.error('Logout error:', error);
      // 에러가 발생해도 클라이언트 측 토큰은 삭제
      delete window.accessToken;
    }
  }

  // API 요청 시 Access Token 자동 포함하는 함수 (유틸리티)
  async function apiRequest(url, options = {}) {
    const accessToken = window.accessToken;

    const defaultOptions = {
      headers: {
        'Content-Type': 'application/json',
        ...(accessToken && { 'Authorization': `Bearer ${accessToken}` })
      },
      credentials: 'include',
      ...options
    };

    let response = await fetch(url, defaultOptions);

    // Access Token이 만료된 경우 (401 에러)
    if (response.status === 401 && accessToken) {
      console.log('Access Token 만료, 갱신 시도...');

      // Refresh Token으로 새 Access Token 요청
      const refreshResponse = await fetch('/api/member/refresh', {
        method: 'POST',
        credentials: 'include'
      });

      if (refreshResponse.ok) {
        const refreshResult = await refreshResponse.json();
        // SuccessApiResponse 구조: { success: true, data: { accessToken: "..." } }
        if (refreshResult.success) {
          // 새로운 Access Token 저장
          window.accessToken = refreshResult.data.accessToken;

          // 원래 요청을 새 토큰으로 재시도
          defaultOptions.headers['Authorization'] = `Bearer ${refreshResult.data.accessToken}`;
          response = await fetch(url, defaultOptions);
        } else {
          // Refresh Token도 만료된 경우 로그인 페이지로 이동
          console.log('Refresh Token 만료, 재로그인 필요');
          delete window.accessToken;
          window.location.href = '/login';
          return;
        }
      }
    }

    return response;
  }

  // 페이지 로드 시 토큰 상태 확인 (선택사항)
  document.addEventListener('DOMContentLoaded', function() {
    console.log('페이지 로드됨');
    // 필요한 경우 여기에 초기화 코드 추가
  });
</script>
</body>
</html>